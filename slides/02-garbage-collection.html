<!-- 2. COST OF GARBAGE COLLECTION -->
<section id="garbage-collection">
  <section class="section-header">
    <h2>Cost of Garbage Collection</h2>
    <p>Young generation vs Old generation</p>
  </section>

  <section>
    <h3>V8's Generational GC</h3>
    <div class="diagram-box">
      <div class="diagram-title">V8 Heap</div>
      <div class="diagram-row">
        <div class="diagram-cell good">
          <h4>Young Gen</h4>
          <div class="subtitle">Scavenge</div>
          <ul>
            <li>~1–128 MB</li>
            <li>~1 ms pause</li>
            <li>Cheap</li>
          </ul>
        </div>
        <div class="diagram-cell bad">
          <h4>Old Gen</h4>
          <div class="subtitle">Mark-Sweep-Compact</div>
          <ul>
            <li>~thousands of MB</li>
            <li>~10–1000+ ms pause</li>
            <li>Expensive</li>
          </ul>
        </div>
      </div>
    </div>
    <aside class="notes">
      V8 uses a generational garbage collector. Most objects die young.
      The young generation is collected frequently but cheaply.
      The old generation is collected rarely but it's expensive.
    </aside>
  </section>

  <section>
    <h3>The Generational Hypothesis</h3>
    <ul class="spaced">
      <li><strong>Most objects die young</strong> — allocated, used briefly, discarded</li>
      <li><strong>Scavenge (Minor GC)</strong>: copies survivors to "to-space", very fast</li>
      <li><strong>Mark-Sweep-Compact (Major GC)</strong>: walks entire old generation heap</li>
      <li>Objects that survive 2 scavenges get <strong>promoted to old generation</strong></li>
    </ul>
    <div class="insight">
      Goal: keep objects short-lived (young gen) or truly long-lived (old gen).
      The worst case is medium-lived objects that get promoted then die.
    </div>
  </section>

  <section>
    <h3>Scavenge vs Mark-Sweep</h3>
    <!-- Scavenge: copy collector -->
    <div style="display:flex;gap:16px;margin-bottom:8px">
      <div style="flex:1">
        <div style="color:#4ec9b0;font-weight:bold;font-size:0.8em;margin-bottom:6px">Scavenge — Copy Collector (Young Gen)</div>
        <div style="display:flex;gap:2px;height:30px;margin-bottom:4px">
          <div style="flex:1;background:#555;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#888;font-size:0.6em">dead</div>
          <div style="flex:1;background:#4ec9b0;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.65em">A</div>
          <div style="flex:1;background:#555;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#888;font-size:0.6em">dead</div>
          <div style="flex:1;background:#555;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#888;font-size:0.6em">dead</div>
          <div style="flex:1;background:#555;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#888;font-size:0.6em">dead</div>
          <div style="flex:1;background:#555;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#888;font-size:0.6em">dead</div>
          <div style="flex:1;background:#555;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#888;font-size:0.6em">dead</div>
          <div style="flex:1;background:#4ec9b0;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.65em">B</div>
        </div>
        <div style="text-align:center;color:#4ec9b0;font-size:0.65em;margin-bottom:4px">copy survivors &darr;</div>
        <div style="display:flex;gap:2px;height:30px;margin-bottom:6px">
          <div style="flex:1;background:#4ec9b0;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.65em">A</div>
          <div style="flex:1;background:#4ec9b0;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.65em">B</div>
          <div style="flex:1;background:#333;border:1px dashed #555;border-radius:3px"></div>
          <div style="flex:1;background:#333;border:1px dashed #555;border-radius:3px"></div>
          <div style="flex:1;background:#333;border:1px dashed #555;border-radius:3px"></div>
          <div style="flex:1;background:#333;border:1px dashed #555;border-radius:3px"></div>
          <div style="flex:1;background:#333;border:1px dashed #555;border-radius:3px"></div>
          <div style="flex:1;background:#333;border:1px dashed #555;border-radius:3px"></div>
        </div>
        <div style="background:#1a1a1a;border-radius:6px;padding:8px 10px;border-left:3px solid #4ec9b0;font-size:0.6em">
          <strong style="color:#4ec9b0">Cheap when most objects die — nothing to copy.</strong><br>
          <span style="color:#999">Cost &prop; survivors. Larger young gen &rarr; more time for objects to die, but also more births. Workload dependent.</span>
        </div>
      </div>
      <!-- Mark-Sweep: trace collector -->
      <div style="flex:1">
        <div style="color:#ff5252;font-weight:bold;font-size:0.8em;margin-bottom:6px">Mark-Sweep — Trace Collector (Old Gen)</div>
        <div style="display:flex;gap:2px;height:30px;margin-bottom:4px">
          <div style="flex:1;background:#e7ad52;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.55em">A &#10003;</div>
          <div style="flex:1;background:#e7ad52;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.55em">B &#10003;</div>
          <div style="flex:1;background:#555;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#888;font-size:0.6em">dead</div>
          <div style="flex:1;background:#e7ad52;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.55em">C &#10003;</div>
          <div style="flex:1;background:#e7ad52;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.55em">D &#10003;</div>
          <div style="flex:1;background:#e7ad52;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.55em">E &#10003;</div>
          <div style="flex:1;background:#555;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#888;font-size:0.6em">dead</div>
          <div style="flex:1;background:#e7ad52;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.55em">F &#10003;</div>
        </div>
        <div style="font-size:0.55em;color:#ff5252;font-family:monospace;margin-bottom:4px;text-align:center">
          root &rarr; A &rarr; B &rarr; C &rarr; D &rarr; E &rarr; F &nbsp; <span style="color:#888">(trace all reachable)</span>
        </div>
        <div style="text-align:center;color:#e7ad52;font-size:0.65em;margin-bottom:4px">sweep unmarked &darr;</div>
        <div style="display:flex;gap:2px;height:30px;margin-bottom:6px">
          <div style="flex:1;background:#e7ad52;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.65em">A</div>
          <div style="flex:1;background:#e7ad52;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.65em">B</div>
          <div style="flex:1;background:#333;border:1px dashed #555;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#555;font-size:0.55em">free</div>
          <div style="flex:1;background:#e7ad52;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.65em">C</div>
          <div style="flex:1;background:#e7ad52;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.65em">D</div>
          <div style="flex:1;background:#e7ad52;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.65em">E</div>
          <div style="flex:1;background:#333;border:1px dashed #555;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#555;font-size:0.55em">free</div>
          <div style="flex:1;background:#e7ad52;border-radius:3px;display:flex;align-items:center;justify-content:center;color:#111;font-weight:bold;font-size:0.65em">F</div>
        </div>
        <div style="background:#1a1a1a;border-radius:6px;padding:8px 10px;border-left:3px solid #ff5252;font-size:0.6em">
          <strong style="color:#ff5252">Must trace every reachable object. No copying.</strong><br>
          <span style="color:#999">Cached/pooled objects are traced every major GC — even if idle.</span>
        </div>
      </div>
    </div>
    <div class="insight">
      Scavenge is cheap because dead objects cost nothing. Mark-Sweep is expensive because <strong>every live object</strong> costs work to trace.
    </div>
  </section>

  <section>
    <h3>What Makes GC Expensive</h3>
    <pre><code class="language-javascript">// BAD: Objects survive into old generation
const cache = new Map()
function process(data) {
  const result = { ...data, processed: true }
  cache.set(data.id, result)  // retained → promoted → expensive GC
}

// GOOD: Short-lived objects die in young generation
function process(data) {
  return transform(data)  // dies after return — cheap scavenge
}

// BEST: Avoid allocation entirely — reuse objects
const reusable = { buffer: null, offset: 0, length: 0 }
function process(data) {
  reusable.buffer = data.buffer
  reusable.offset = data.offset
  return handle(reusable)
}</code></pre>
  </section>

  <section>
    <h3>GC Impact on Latency</h3>
    <ul class="spaced">
      <li>Minor GC (Scavenge): <strong>~0.5–2 ms</strong> — usually fine</li>
      <li>Major GC (Mark-Compact): <strong>~10–100+ ms</strong> — P99 killer</li>
      <li>GC blocks your event loop</li>
      <li>More objects → more work for the GC → higher tail latency</li>
    </ul>
    <div class="insight">
      Every object you allocate is work for the GC. Caching reduces allocations but
      creates long-lived objects the GC must trace on every major collection —
      even if you never touch them again. Choose your trade-off deliberately.
    </div>
  </section>

  <section>
    <h3>GC: Less Visible ≠ Free</h3>
    <div class="warning">
      Modern V8 does much GC work on background threads — so you may not see event loop lag.
      But GC still consumes CPU cores, memory bandwidth, and cache lines. Less visible ≠ free.
      On a busy server, GC load competes with your actual work for system resources.
    </div>
    <ul class="spaced">
      <li>Background GC threads compete for <strong>CPU cores</strong> with your application</li>
      <li>Tracing objects pollutes <strong>CPU caches</strong> — evicts your hot data</li>
      <li>More live objects = more memory bandwidth consumed by the GC</li>
      <li>On a multi-tenant server, GC load from one process affects <strong>all others</strong></li>
    </ul>
  </section>

  <section>
    <h3>Object Pooling / Caching — Trade-offs</h3>
    <div style="display:flex;gap:12px;margin-bottom:10px">
      <div style="flex:1;background:#1a1a1a;border-radius:6px;padding:10px 14px;border-left:3px solid #4ec9b0">
        <div style="color:#4ec9b0;font-weight:bold;font-size:0.8em;margin-bottom:4px">Reuse = fewer allocations</div>
        <div style="color:#999;font-size:0.7em">No young-gen churn, no promotion, no scavenge pressure</div>
      </div>
      <div style="flex:1;background:#1a1a1a;border-radius:6px;padding:10px 14px;border-left:3px solid #ff5252">
        <div style="color:#ff5252;font-weight:bold;font-size:0.8em;margin-bottom:4px">Large pool = large old-gen heap</div>
        <div style="color:#999;font-size:0.7em">Every pooled object must be traced on major GC — even if idle</div>
      </div>
    </div>
    <pre><code class="language-javascript">function acquire() { pool.pop() || new Obj() }

// Unbounded pool — DANGEROUS
// 100k idle objects in old gen → major GC must trace them all
function release(obj) {
  pool.push(obj) // pool grows forever
}

// Bounded pool — SAFE
function release(obj) {
  if (pool.length < 1000) pool.push(obj) // cap the pool size
  // else: let GC collect it — that's fine
}</code></pre>
  </section>

  <section>
    <h3>Object Pooling — Pitfalls</h3>
    <div class="warning">
      Pooling reduces allocation cost but increases major GC tracing cost.
      Always bound your pool size — an unbounded pool is a memory leak that also makes GC slower.
      A bounded pool that constantly overflows is worse than no pool: you pay the tracing cost
      for pooled objects AND the allocation cost for the overflow. Size pools to actual reuse.
    </div>
  </section>
</section>
