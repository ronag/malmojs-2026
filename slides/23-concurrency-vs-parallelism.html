<!-- CONCURRENCY VS PARALLELISM -->
<section id="concurrency-vs-parallelism">
  <section class="section-header">
    <h2>Concurrency vs Parallelism</h2>
    <p>Latency vs throughput — and the cost of both</p>
  </section>

  <section>
    <h3>Two Different Goals</h3>
    <div class="diagram-box">
      <div class="diagram-row">
        <div class="diagram-cell good">
          <h4>Concurrency (interleaving)</h4>
          <div class="subtitle">Goal: Improve LATENCY</div>
          <div class="timeline">
            <span class="label">Thread 1:</span>
            <span class="bar work" style="width:30px"></span>
            <span class="bar idle" style="width:20px"></span>
            <span class="bar work" style="width:30px"></span>
            <span class="bar idle" style="width:20px"></span>
            <span class="bar work" style="width:30px"></span>
            <span class="bar idle" style="width:20px"></span>
            <span class="bar work" style="width:30px"></span>
          </div>
          <p style="color:#999;font-size:0.85em;margin:6px 0 12px 88px">yield to other work while waiting (I/O)</p>
          <ul>
            <li>One CPU core, many tasks</li>
            <li>Don't block — switch</li>
            <li>Node.js event loop</li>
            <li>async/await, callbacks</li>
          </ul>
        </div>
        <div class="diagram-cell" style="border-color:#42affa">
          <h4 style="color:#42affa">Parallelism (simultaneous)</h4>
          <div class="subtitle">Goal: Improve THROUGHPUT</div>
          <div class="timeline">
            <span class="label">Thread 1:</span>
            <span class="bar work" style="width:100%;max-width:180px"></span>
          </div>
          <div class="timeline">
            <span class="label">Thread 2:</span>
            <span class="bar work" style="width:100%;max-width:180px"></span>
          </div>
          <div class="timeline">
            <span class="label">Thread 3:</span>
            <span class="bar work" style="width:100%;max-width:180px"></span>
          </div>
          <div class="timeline">
            <span class="label">Thread 4:</span>
            <span class="bar work" style="width:100%;max-width:180px"></span>
          </div>
          <ul style="margin-top:12px">
            <li>Many CPU cores, many tasks</li>
            <li>Do more work per second</li>
            <li>Worker threads</li>
            <li>cluster, child_process</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section>
    <h3>The Hidden Costs</h3>
    <div style="font-size:0.7em;color:#999;margin-bottom:10px;text-align:center">
      Both add <strong style="color:#ccc">absolute overhead</strong> — sync single-threaded is fastest per unit of work
    </div>
    <div style="display:flex;gap:14px">
      <div class="diagram-box" style="flex:1;padding:12px 16px;border-color:#4ec9b0">
        <div style="color:#4ec9b0;font-weight:bold;font-size:1em;margin-bottom:8px">Concurrency Overhead</div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <div style="display:flex;align-items:baseline;gap:8px">
            <div style="width:6px;height:6px;border-radius:50%;background:#4ec9b0;flex-shrink:0;position:relative;top:-1px"></div>
            <div style="color:#ccc">Promise/callback scheduling <span style="color:#e7ad52;font-weight:bold">~40ns per await</span></div>
          </div>
          <div style="display:flex;align-items:baseline;gap:8px">
            <div style="width:6px;height:6px;border-radius:50%;background:#4ec9b0;flex-shrink:0;position:relative;top:-1px"></div>
            <div style="color:#ccc">Microtask queue processing</div>
          </div>
          <div style="display:flex;align-items:baseline;gap:8px">
            <div style="width:6px;height:6px;border-radius:50%;background:#4ec9b0;flex-shrink:0;position:relative;top:-1px"></div>
            <div style="color:#ccc">Async context switching</div>
          </div>
        </div>
      </div>
      <div class="diagram-box" style="flex:1;padding:12px 16px;border-color:#42affa">
        <div style="color:#42affa;font-weight:bold;font-size:1em;margin-bottom:8px">Parallelism Overhead</div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <div style="display:flex;align-items:baseline;gap:8px">
            <div style="width:6px;height:6px;border-radius:50%;background:#42affa;flex-shrink:0;position:relative;top:-1px"></div>
            <div style="color:#ccc">Cross-thread comm <span style="color:#e7ad52;font-weight:bold">~400ns</span> postMessage / <span style="color:#e7ad52;font-weight:bold">~90ns</span> ring</div>
          </div>
          <div style="display:flex;align-items:baseline;gap:8px">
            <div style="width:6px;height:6px;border-radius:50%;background:#42affa;flex-shrink:0;position:relative;top:-1px"></div>
            <div style="color:#ccc">CPU cache pollution (L1/L2/L3 thrashing)</div>
          </div>
          <div style="display:flex;align-items:baseline;gap:8px">
            <div style="width:6px;height:6px;border-radius:50%;background:#42affa;flex-shrink:0;position:relative;top:-1px"></div>
            <div style="color:#ccc">Memory duplication (each thread = own V8 heap + GC)</div>
          </div>
          <div style="display:flex;align-items:baseline;gap:8px">
            <div style="width:6px;height:6px;border-radius:50%;background:#42affa;flex-shrink:0;position:relative;top:-1px"></div>
            <div style="color:#ccc">Atomics, locks, OS scheduling</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section>
    <h3>CPU Cache — The Real Bottleneck</h3>
    <div class="diagram-box">
      <div style="display:flex;gap:24px">
        <div style="flex:1">
          <div class="diagram-title" style="color:#4ec9b0;margin-bottom:8px;text-align:left">Single thread</div>
          <div class="cache-core" style="border-color:#4ec9b0;min-width:160px">
            <div class="core-label">Core 0</div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0">
              <span class="cache-line" style="padding:0">L1 32K</span>
              <span style="color:#4ec9b0;font-size:0.8em;font-weight:bold">~1ns</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0">
              <span class="cache-line" style="padding:0">L2 256K</span>
              <span style="color:#4ec9b0;font-size:0.8em;font-weight:bold">~4ns</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:2px 0;border-top:1px solid #444;margin-top:4px;padding-top:4px">
              <span class="cache-line" style="padding:0">L3 shared</span>
              <span style="color:#e7ad52;font-size:0.8em;font-weight:bold">~10ns</span>
            </div>
          </div>
          <div style="color:#4ec9b0;font-size:0.85em;margin-top:8px">Data stays in L1/L2 — hot and fast</div>
        </div>
        <div style="flex:1.3">
          <div class="diagram-title" style="color:#ff5252;margin-bottom:8px;text-align:left">Multiple threads: cache thrashing</div>
          <div style="display:flex;gap:8px;justify-content:center">
            <div class="cache-core" style="padding:6px 8px;min-width:60px">
              <div class="core-label" style="font-size:0.85em">Core 0</div>
              <div class="cache-line">L1 / L2</div>
            </div>
            <div class="cache-core" style="padding:6px 8px;min-width:60px">
              <div class="core-label" style="font-size:0.85em">Core 1</div>
              <div class="cache-line">L1 / L2</div>
            </div>
            <div class="cache-core" style="padding:6px 8px;min-width:60px">
              <div class="core-label" style="font-size:0.85em">Core 2</div>
              <div class="cache-line">L1 / L2</div>
            </div>
            <div class="cache-core" style="padding:6px 8px;min-width:60px">
              <div class="core-label" style="font-size:0.85em">Core 3</div>
              <div class="cache-line">L1 / L2</div>
            </div>
          </div>
          <div class="shared-bus" style="margin-top:6px;padding-top:4px">shared L3 cache</div>
          <ul style="list-style:none;padding:6px 0 0;margin:0;color:#bbb;font-size:0.8em">
            <li>Each thread evicts the other's cache lines</li>
            <li>Shared data → false sharing</li>
            <li>More threads ≠ more throughput</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section>
    <h3>When to Use What</h3>
    <div style="display:flex;gap:10px;margin-bottom:10px">
      <div class="diagram-box" style="flex:1;padding:10px 14px;border-color:#4ec9b0">
        <div style="color:#4ec9b0;font-weight:bold;font-size:0.95em;margin-bottom:6px">Stay Single-Threaded</div>
        <ul style="list-style:none;padding:0;margin:0;font-size:0.9em;color:#ccc">
          <li style="padding:3px 0">CPU work is small (&lt; 1ms)</li>
          <li style="padding:3px 0">Data fits in cache, accessed often</li>
          <li style="padding:3px 0">Per-request latency matters most</li>
        </ul>
      </div>
      <div class="diagram-box" style="flex:1;padding:10px 14px;border-color:#e7ad52">
        <div style="color:#e7ad52;font-weight:bold;font-size:0.95em;margin-bottom:6px">Use Concurrency (async)</div>
        <ul style="list-style:none;padding:0;margin:0;font-size:0.9em;color:#ccc">
          <li style="padding:3px 0">Waiting on I/O (network, disk, DNS)</li>
          <li style="padding:3px 0">Many simultaneous connections</li>
          <li style="padding:3px 0">I/O-bound, not CPU-bound</li>
        </ul>
      </div>
      <div class="diagram-box" style="flex:1;padding:10px 14px;border-color:#42affa">
        <div style="color:#42affa;font-weight:bold;font-size:0.95em;margin-bottom:6px">Use Parallelism (workers)</div>
        <ul style="list-style:none;padding:0;margin:0;font-size:0.9em;color:#ccc">
          <li style="padding:3px 0">CPU work exceeds ~40ms</li>
          <li style="padding:3px 0">Throughput &gt; per-unit cost</li>
          <li style="padding:3px 0">Independent, no shared state</li>
          <li style="padding:3px 0">Comm overhead worth the gains</li>
        </ul>
      </div>
    </div>
    <div class="insight">
      Default to single-threaded. Add async for I/O-bound work. Only reach for
      workers when CPU work exceeds ~40ms — and measure to prove the overhead is worth it.
    </div>
  </section>
</section>
