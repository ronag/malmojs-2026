<!-- 15. GC FLAGS & SETTINGS -->
<section id="gc-flags">
  <section class="section-header">
    <h2>GC Flags &amp; Settings in Node.js</h2>
    <p>Tuning V8's garbage collector</p>
  </section>

  <section>
    <h3>Essential Flags</h3>
    <pre><code class="language-bash"># Increase old generation heap size (default: ~1.5-2 GB)
node --max-old-space-size=4096 server.js

# Increase young generation (semi-space) size
# Default: 16 MB per semi-space → try 64 MB for high-alloc workloads
node --max-semi-space-size=64 server.js

# Expose GC for manual triggering (debugging only)
node --expose-gc server.js

# Track GC events
node --trace-gc server.js
# Output: [12345:0x...] 42 ms: Scavenge 12.3 (20.4) -> 6.1 (20.4) MB, 1.2 / 0.0 ms ...

# Detailed GC stats
node --trace-gc-verbose server.js</code></pre>
  </section>

  <section>
    <h3>Semi-Space Size Tuning</h3>
    <pre><code class="language-bash"># Young generation = 2 semi-spaces (from-space + to-space)
# Scavenge copies live objects from one to the other

# Small semi-space (default 16MB):
# + Frequent scavenges keep pause times low
# - Objects promoted to old gen faster → more major GC
# Good for: latency-sensitive, low-allocation workloads

# Large semi-space (64-128MB):
# + Objects die before promotion → less old gen pressure
# - Each scavenge copies more data → longer minor GC pauses
# Good for: high-throughput, high-allocation workloads

node --max-semi-space-size=64 server.js  # Try this first</code></pre>
    <div class="insight">
      Increasing semi-space size is often the single biggest GC win.
      Short-lived objects die in young gen instead of being promoted.
      This means fewer expensive major GC pauses.
    </div>
  </section>

  <section>
    <h3>Monitoring GC in Production</h3>
    <pre><code class="language-javascript">import { PerformanceObserver } from 'node:perf_hooks'

const obs = new PerformanceObserver((list) => {
  for (const entry of list.getEntries()) {
    const kind = ['', 'Scavenge', 'Mark-Sweep', '', 'Incremental']
    console.log({
      type: kind[entry.kind] || 'Other',
      duration: entry.duration.toFixed(2) + 'ms',
    })
  }
})
obs.observe({ entryTypes: ['gc'] })
// Track: scavenge freq, mark-sweep duration (the killer),
// heap used vs --max-old-space-size</code></pre>
  </section>
</section>
